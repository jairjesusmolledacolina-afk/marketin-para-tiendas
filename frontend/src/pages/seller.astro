--- 
import Header from '../components/Header.astro';
const API = import.meta.env.VITE_API_URL || 'http://localhost:4000';
--- 
<html>
  <head>
    <meta charset=\"utf-8\" />
    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />
    <title>Seller — TiendasCoro</title>
    <link rel=\"stylesheet\" href=\"/src/styles/global.css\" />
  </head>
  <body>
    <Header />
    <main class=\"container\">
      <h1 class=\"text-2xl font-bold mb-4\">Panel Seller</h1>

      <section class=\"mb-6\">
        <h2 class=\"font-semibold mb-2\">Crear tienda</h2>
        <form id=\"storeForm\" class=\"card max-w-md\">
          <input name=\"name\" placeholder=\"Nombre tienda\" class=\"w-full border rounded px-2 py-1 mb-2\" required />
          <input name=\"description\" placeholder=\"Descripción\" class=\"w-full border rounded px-2 py-1 mb-2\" />
          <input name=\"address\" placeholder=\"Dirección\" class=\"w-full border rounded px-2 py-1 mb-2\" />
          <div class=\"flex gap-2\">
            <input name=\"lat\" placeholder=\"lat\" class=\"w-1/2 border rounded px-2 py-1\" />
            <input name=\"lng\" placeholder=\"lng\" class=\"w-1/2 border rounded px-2 py-1\" />
          </div>
          <button class=\"mt-3 bg-indigo-600 text-white px-4 py-2 rounded\">Crear tienda</button>
          <div id=\"storeMsg\" class=\"mt-2 text-sm\"></div>
        </form>
      </section>

      <section class=\"mb-6\">
        <h2 class=\"font-semibold mb-2\">Crear producto</h2>
        <form id=\"productForm\" class=\"card max-w-md\">
          <input name=\"title\" placeholder=\"Título\" class=\"w-full border rounded px-2 py-1 mb-2\" required />
          <input name=\"description\" placeholder=\"Descripción\" class=\"w-full border rounded px-2 py-1 mb-2\" />
          <input name=\"price\" placeholder=\"Precio\" type=\"number\" step=\"0.01\" class=\"w-full border rounded px-2 py-1 mb-2\" required />
          <label class=\"block mb-2\">
            Seleccionar tienda:
            <select id=\"storeSelect\" name=\"storeId\" class=\"w-full border rounded px-2 py-1\"></select>
          </label>
          <button class=\"mt-3 bg-indigo-600 text-white px-4 py-2 rounded\">Crear producto</button>
          <div id=\"productMsg\" class=\"mt-2 text-sm\"></div>
        </form>
      </section>

      <section>
        <h2 class=\"font-semibold mb-2\">Mis tiendas</h2>
        <div id=\"myStores\" class=\"space-y-2\"></div>
      </section>
    </main>

    <script is:inline>
      (function () {
        const API = import.meta.env.VITE_API_URL || 'http://localhost:4000';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!token || !user) {
          alert('Acceso restringido. Inicia sesión como seller.');
          location.href = '/login';
          return;
        }

        const headers = { Authorization: Bearer , 'Content-Type': 'application/json' };
        const storeForm = document.getElementById('storeForm');
        const productForm = document.getElementById('productForm');
        const storeSelect = document.getElementById('storeSelect');
        const myStores = document.getElementById('myStores');
        const storeMsg = document.getElementById('storeMsg');
        const productMsg = document.getElementById('productMsg');

        async function loadStores() {
          try {
            const res = await fetch(${API}/api/stores);
            const arr = await res.json();
            const mine = Array.isArray(arr) ? arr.filter(s => s.owner && s.owner.email === user.email) : [];
            storeSelect.innerHTML = '';
            myStores.innerHTML = '';
            for (const s of mine) {
              const opt = document.createElement('option');
              opt.value = s._id;
              opt.textContent = s.name;
              storeSelect.appendChild(opt);

              const div = document.createElement('div');
              div.className = 'card';
              div.innerHTML = <strong></strong><div class=\"text-sm text-gray-600\"></div><div class=\"text-xs text-gray-500\">id: </div>;
              myStores.appendChild(div);
            }
            if (mine.length === 0) {
              storeSelect.innerHTML = '<option value=\"\">-- crea una tienda primero --</option>';
              myStores.innerHTML = '<div class=\"card\">No tienes tiendas aún.</div>';
            }
          } catch (err) {
            console.error(err);
          }
        }

        storeForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          storeMsg.textContent = '';
          const formData = Object.fromEntries(new FormData(storeForm));
          const payload = {
            name: formData.name,
            description: formData.description,
            address: formData.address,
            location: {
              lat: parseFloat(formData.lat) || 0,
              lng: parseFloat(formData.lng) || 0
            }
          };
          try {
            const res = await fetch(${API}/api/stores, { method: 'POST', headers, body: JSON.stringify(payload) });
            const j = await res.json();
            if (!res.ok) {
              storeMsg.textContent = j.message || 'Error';
              return;
            }
            storeMsg.textContent = 'Tienda creada';
            storeForm.reset();
            await loadStores();
          } catch (err) {
            console.error(err);
            storeMsg.textContent = 'Error de red';
          }
        });

        productForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          productMsg.textContent = '';
          const formData = Object.fromEntries(new FormData(productForm));
          if (!formData.storeId) {
            productMsg.textContent = 'Selecciona una tienda';
            return;
          }
          const payload = {
            title: formData.title,
            description: formData.description,
            price: parseFloat(formData.price) || 0,
            images: [],
            storeId: formData.storeId
          };
          try {
            const res = await fetch(${API}/api/products, { method: 'POST', headers, body: JSON.stringify(payload) });
            const j = await res.json();
            if (!res.ok) {
              productMsg.textContent = j.message || 'Error';
              return;
            }
            productMsg.textContent = 'Producto creado';
            productForm.reset();
          } catch (err) {
            console.error(err);
            productMsg.textContent = 'Error de red';
          }
        });

        loadStores();
      })();
    </script>
  </body>
</html>
